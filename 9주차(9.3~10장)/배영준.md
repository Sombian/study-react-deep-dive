# 10장\_리액트 17과 18의 변경 사항 살펴보기

## 리액트 17버전 살펴보기

> 새롭게 추가된 기능 없이 호환성이 깨지는 변경 사항, 기존 코드 수정을 필요로 하는 변경 사항을 최소화하였다.

### 리액트의 점진적인 업그레이드

### 이벤트 위임 방식의 변경

리액트는 이벤트 핸들러를 각각의 DOM에 부착하는 것이 아닌, 이벤트 타입당 하나의 핸들러를 루트에 부착한다.

- 16 버전까지는 모두 document에 부착되고 있다.
- 17 버전부터는 document가 아닌 리액트 컴포넌트 최상단 트리, 즉 루트 요소로 바뀌었다.
- 서로 다른 리액트 버전에서 발생할 수 있는 문제를 해결하기 위해 document에서 컴포넌트의 최상위로 변경했다.

→ 각 리액트 컴포넌트 트리 수준으로 격리되어 버블링으로 인한 혼선을 방지할 수 있음

### import React from ‘react’

더 이상 필요 없다.

바벨과 협력하여 이런 import 구문 없이도 JSX를 변환할 수 있다.

기존 코드에서 import React를 제거하기 위해 밑의 codemod를 사용한다.

```tsx
npx react-codemod update-react-imports
```

### 그 밖의 주요 변경 사항

**이벤트 풀링 제거**

**useEffect 클린업 함수 비동기 실행**

성능적인 이점이 있다.

화면의 업데이트가 완료된 후 클린업 함수가 실행되기 때문이다.

**컴포넌트의 undefined 반환에 대한 일관적인 처리**

`forwardRef`나 `memo`에서 `undefined`를 반환하는 경우 별 다른 에러가 발생하지 않는 문제가 있었는데, 17 버전에서는 일관적으로 처리되도록 변경되었다.

## 리액트 18 버전 살펴보기

### **useId**

컴포넌트 별로 유니크한 값을 생성하는 훅이다.

고유한 값이 필요할 때 사용한다.

### **useTransition**

리액트 18 핵심 변경사항 중 하나인 동시성을 다룰 수 있는 훅이다.

- 과거 리액트의 모든 렌더링은 동기적으로 작동해, 느린 렌더링 작업이 있을 경우 애플리케이션 전체적으로 영향을 끼쳤다.
- 동시성을 지원해 느린 렌더링 과정에서 로딩 화면을 보여주거나, 지금 진행 중인 렌더링을 버리고 새로운 상태값으로 다시 렌더링하는 등의 작업을 할 수 있게 되었다.

UI 변경을 가로막지 않고 상태를 업데이트 할 수 있는 훅이다.

사용할 때 주의점은 다음과 같다.

- startTransition 내부는 반드시 상태를 업데이트하는 함수와 관련된 작업만 넘길 수 있다.
  - 만약 props나 사용자 정의 훅에서 반환하는 값 등을 사용하고 싶다면 useDeferredValue 훅을 사용해야 한다.
- startTransition으로 넘겨주는 상태 업데이트는 다른 모든 동기 상태 업데이트로 인해 실행이 지연될 수 있다.
  - 타이핑으로 setState하는 경우에는 타이핑이 끝날 때까지 지연시킨 상태 업데이트가 일어나지 않는다.
- startTransition으로 넘겨주는 함수는 동기 함수여야 한다.
  - setTimeout 같은 비동기 함수를 넣으면 제대로 작동하지 않는데, 작업을 지연시키는 작업과 비동기로 함수가 실행되는 작업 사이에 불일치가 일어나기 때문이다.

### **useDeferredValue**

리렌더링이 급하지 않은 부분을 지연할 수 있게 도와주는 훅이다.

고정된 지연 시간 없이, 첫 번째 렌더링이 완료 된 이후에 지연된 렌더링을 수행한다.

`useTransition`은 `state` 값을 업데이트하는 함수를 감싸서 사용하지만, `useDeferredValue`는 `state` 자체만을 감싸서 사용하는 것을 볼 수 있다.

### **useSyncExternalStore**

`seTransition`, `useDefferedValue`를 사용해 동시성 이슈가 발생할 수 있습니다.

외부 데이터 소스에 리액트에서 추구하는 동시성 처리가 추가돼 있지 않다면 테어링(tearing) 현상이 발생할 수 있어서 이 문제를 해결하기 위한 훅이다.

### **useInsertionEffect**

`useSyncExternalStore`가 상태 관리 라이브러리를 위한 훅이라면, **`useInsertionEffect`** 는 CSS-in-js 라이브러리를 위한 훅입니다.

### **react-dom/client**

클라이언트에서 리액트 트리를 만들 때 사용되는 API가 변경됐다.

**createRoot**

기존의 react-dom에 있던 render 메서드를 대체할 새로운 메서드이다.

**hydrateRoot**

서버 사이드 렌더링 애플리케이션에서 하이드레이션을 하기 위한 새로운 메서드이다.

### **react-dom/server**

**renderToPipeableStream**

리액트 컴포넌트를 HTML로 렌더링하는 메서드이다.

클라이언트에서는 중간에 script를 삽입하는 등의 작업을 할 수 있다.

**rederToReadableStream**

웹 스트림을 기반으로 작동한다는 차이가 있다.

### **자동 배치(Automatic Batching)**

여러 상태 업데이트를 하나의 리렌더링으로 묶어서 성능을 향상시키는 방법을 의미한다.

### 더욱 엄격해진 엄격 모드

**리액트의 엄격 모드**

더 이상 안전하지 않은 특정 생명주기를 사용하는 컴포넌트에 대한 경고로 별도의 로그를 확인할 수 있다.

과거에는 `createRef` 없이 컴포넌트 내부에서 문자열로 `ref`를 생성하고 이를 사용해 DOM에 접근할 수 있었는데, 몇 가지 문제가 있어 사용이 금지됐고 따라서 엄격 모드에서는 경고 문구가 출력된다.

`findDOMNode`는 클래스 컴포넌트에서 실제 DOM 요소에 대한 참조를 가져올 수 있는 메서드로 현재는 권장되지 않기 때문에 경고 문구가 출력된다.

구 `Context API` 사용 시 발생하는 경고가 존재한다.

예상치 못한 부작용(side-effects) 검사로, 리액트 엄격 모드 내부에서는 다음을 의도적으로 이중으로 호출한다.

클래스형 컴포넌트의 `constructor`, `render`, `shouldComponentUpdate`, `getDerivedStateFromProps`

클래스형 컴포넌트의 `setState`의 첫 번째 인수

함수형 컴포넌트의 `body`

`useState`, `useMemo`, `useReducer`에 전달되는 함수

### **Suspense 기능 강화**

컴포넌트를 동적으로 가져올 수 있게 도와주는 기능이다.

Suspense는 두 개의 인수를 받는데, 하나는 `fallback` props로, 지연시켜 불러온 컴포넌트를 미처 불러오지 못했을 때 보여주는 `fallback`을 나타낸다.

그리고 `children`으로는 `React.lazy`로 선언한 지연 컴포넌트를 받는다.

지연 컴포넌트를 로딩하기 전에는 `fallback`을 보여주고, 지연 로딩이 완료되면 해당 컴포넌트를 보여주게 된다.
